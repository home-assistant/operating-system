# Home Assistant Operating System build workflow (Green board only)

name: OS build

on:
  workflow_dispatch:
    inputs:
      boards:
        description: 'List of boards to build (comma separated identifiers)'
        required: false
        type: string
        default: 'green'
      release_ref:
        description: 'Git ref (tag or branch) to checkout and build (e.g. "16.3"). Leave empty for dev build of current branch.'
        required: false
        type: string
        default: ''
      hassio_channel:
        description: 'Release channel to use (default: stable when building a release tag, dev otherwise)'
        type: choice
        required: true
        default: default
        options:
          - default
          - stable
          - beta
          - dev

env:
  PYTHON_VERSION: "3.13"

jobs:
  prepare:
    name: Prepare build
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      pull-requests: read
    outputs:
      version_dev: ${{ steps.version_dev.outputs.version_dev }}
      version_main: ${{ steps.version.outputs.version_main }}
      version_full: ${{ steps.version.outputs.version_full }}
      channel: ${{ steps.channel.outputs.channel }}
      hassio_channel_option: ${{ steps.channel.outputs.hassio_channel_option }}
      matrix: ${{ steps.generate_matrix.outputs.result }}
      self_signed_cert: ${{ steps.generate_signing_key.outputs.self_signed_cert }}
    steps:
      - name: Checkout source
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ inputs.release_ref || github.ref }}
          persist-credentials: false

      - name: Generate development version
        shell: bash
        id: version_dev
        if: ${{ inputs.release_ref == '' }}
        run: |
          version_dev="dev$(date +%s)"
          echo "Development version \"${version_dev}\""
          echo "version_dev=${version_dev}" >> $GITHUB_OUTPUT

      - name: Set version suffix
        if: ${{ inputs.release_ref == '' }}
        env:
          VERSION_DEV: ${{ steps.version_dev.outputs.version_dev }}
        run: |
          sed -i -E "s/(^VERSION_SUFFIX=\").*(\"$)/\1${VERSION_DEV}\2/" buildroot-external/meta

      - name: Get version
        id: version
        run: |
          . ${GITHUB_WORKSPACE}/buildroot-external/meta
          echo "version_main=${VERSION_MAJOR}.${VERSION_MINOR}" >> $GITHUB_OUTPUT
          if [ -z "${VERSION_SUFFIX}" ]; then
            version_full="${VERSION_MAJOR}.${VERSION_MINOR}"
          else
            version_full="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_SUFFIX}"
          fi
          echo "version_full=${version_full}" >> $GITHUB_OUTPUT
          echo "Full version number of this release is \"${version_full}\"."

      - name: Validate release ref version
        if: ${{ inputs.release_ref != '' }}
        run: |
          echo "Building from ref: ${{ inputs.release_ref }}"
          echo "Version from meta: ${{ steps.version.outputs.version_full }}"
          if [ "${{ steps.version.outputs.version_full }}" != "${{ inputs.release_ref }}" ]; then
            echo "::warning::Version in buildroot-external/meta (${{ steps.version.outputs.version_full }}) does not match the provided ref (${{ inputs.release_ref }}). This may be intentional if building from a branch."
          fi

      - name: Get channel
        id: channel
        run: |
          if [[ "${{ inputs.hassio_channel }}" != "default" ]]; then
            channel="${{ inputs.hassio_channel }}"
          elif [[ -n "${{ inputs.release_ref }}" ]]; then
            channel="stable"
          else
            channel="dev"
          fi
          echo "channel=${channel}" >> "$GITHUB_OUTPUT"

          if [[ "${channel}" == "stable" ]]; then
            echo "hassio_channel_option=BR2_PACKAGE_HASSIO_CHANNEL_STABLE" >> "$GITHUB_OUTPUT"
          elif [[ "${channel}" == "beta" ]]; then
            echo "hassio_channel_option=BR2_PACKAGE_HASSIO_CHANNEL_BETA" >> "$GITHUB_OUTPUT"
          elif [[ "${channel}" == "dev" ]]; then
            echo "hassio_channel_option=BR2_PACKAGE_HASSIO_CHANNEL_DEV" >> "$GITHUB_OUTPUT"
          fi

      - name: Create build matrix
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        id: generate_matrix
        with:
          script: |
            const boards = require('./.github/workflows/matrix.json')
            const boardFilter = "${{ inputs.boards }}"

            if (boardFilter == "" || boardFilter == "green") {
              console.log("Building for all boards in matrix.json")
              return { "board": boards }
            } else {
              console.log("Run partial build with board filter: " + boardFilter)
              const boardSet = new Set(boardFilter.split(","))
              const buildBoards = boards.filter(b => boardSet.has(b.id))
              if (buildBoards.length === 0) {
                core.setFailed("No matching boards found for filter: " + boardFilter)
                return { "board": [] }
              }
              return { "board": buildBoards }
            }

      - name: Generate self-signed certificate
        id: generate_signing_key
        env:
          RAUC_CERTIFICATE: ${{ secrets.RAUC_CERTIFICATE }}
          RAUC_PRIVATE_KEY: ${{ secrets.RAUC_PRIVATE_KEY }}
        if: env.RAUC_CERTIFICATE == '' || env.RAUC_PRIVATE_KEY == ''
        run: |
          echo "::warning:: RAUC certificate or key is missing in the repository secrets. Building with a public self-signed certificate!"
          buildroot-external/scripts/generate-signing-key.sh cert.pem key.pem
          echo "self_signed_cert=true" >> $GITHUB_OUTPUT

      - name: Create signing key
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: steps.generate_signing_key.outcome == 'success'
        with:
          name: signing-key
          path: |
            cert.pem
            key.pem

  build:
    name: Build for ${{ matrix.board.id }}
    permissions:
      contents: read
    needs: prepare
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ inputs.release_ref || github.ref }}
          submodules: true
          persist-credentials: false

      - name: Set version suffix
        if: ${{ inputs.release_ref == '' }}
        env:
          VERSION_DEV: ${{ needs.prepare.outputs.version_dev }}
        run: |
          sed -i -E "s/(^VERSION_SUFFIX=\").*(\"$)/\1${VERSION_DEV}\2/" buildroot-external/meta

      - name: 'Add release PKI certs'
        if: ${{ needs.prepare.outputs.self_signed_cert != 'true' }}
        env:
          RAUC_CERTIFICATE: ${{ secrets.RAUC_CERTIFICATE }}
          RAUC_PRIVATE_KEY: ${{ secrets.RAUC_PRIVATE_KEY }}
        run: |
          echo -e "-----BEGIN CERTIFICATE-----\n${RAUC_CERTIFICATE}\n-----END CERTIFICATE-----" > cert.pem
          echo -e "-----BEGIN PRIVATE KEY-----\n${RAUC_PRIVATE_KEY}\n-----END PRIVATE KEY-----" > key.pem

      - name: Get self-signed certificate from the prepare job
        if: ${{ needs.prepare.outputs.self_signed_cert == 'true' }}
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: signing-key

      - name: Free space on build drive
        run: |
          # Inspired by https://github.com/easimon/maximize-build-space/blob/v7/action.yml
          df -h
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo mkdir /mnt/cache
          sudo mkdir /mnt/output
          WORKSPACE_OWNER="$(stat -c '%U:%G' "${GITHUB_WORKSPACE}")"
          # output directory is symlinked for easier access from workspace
          # but for build container it must be mounted as a volume
          sudo ln -sf /mnt/output "${GITHUB_WORKSPACE}/output"
          sudo chown -R "${WORKSPACE_OWNER}" /mnt/cache
          sudo chown -R "${WORKSPACE_OWNER}" /mnt/output
          df -h

      - name: "Restore cache: object files"
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /mnt/cache/cc
          key: haos-cc-${{ matrix.board.id }}

      - name: Build builder container image
        run: |
          docker build -t haos-builder:local -f Dockerfile .

      - name: Generate build config
        uses: "./.github/actions/haos-builder-command"
        with:
          image: haos-builder:local
          command: make ${{ matrix.board.defconfig }}_defconfig

      - name: Override release channel
        if: ${{ needs.prepare.outputs.hassio_channel_option != 'BR2_PACKAGE_HASSIO_CHANNEL_STABLE' }}
        uses: "./.github/actions/haos-builder-command"
        with:
          image: haos-builder:local
          command: |
            bash -c 'echo "${{ needs.prepare.outputs.hassio_channel_option }}=y" >> /build/output/.config && make olddefconfig'

      - name: Build
        uses: "./.github/actions/haos-builder-command"
        with:
          image: haos-builder:local
          command: make

      - name: Check Linux config
        uses: "./.github/actions/haos-builder-command"
        with:
          image: haos-builder:local
          command: |
            make BR2_CHECK_DOTCONFIG_OPTS="--github-format --strip-path-prefix=/build/" linux-check-dotconfig

      - name: Print cache stats
        run: |
          echo "Cache size: $(du -sh /mnt/cache/cc)"
          echo "Files total: $(find /mnt/cache/cc -mindepth 1 -type f | wc -l)"
          echo "Old files to remove: $(find /mnt/cache/cc -mindepth 1 -type f -not -anewer output/Makefile | wc -l)"
          find /mnt/cache/cc -mindepth 1 -type f -not -anewer output/Makefile -delete
          echo "Cache size after pruning: $(du -sh /mnt/cache/cc)"

      - name: "Save cache: object files"
        if: ${{ inputs.release_ref == '' }}
        uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /mnt/cache/cc
          key: haos-cc-${{ matrix.board.id }}-${{ github.run_id }}

      - name: Generate build summary
        run: |
          echo "# ${{ matrix.board.id }} build summary" >> $GITHUB_STEP_SUMMARY
          echo "## Built-in OS components" >> $GITHUB_STEP_SUMMARY
          echo "Release channel: ${{ inputs.hassio_channel }} (${{ needs.prepare.outputs.hassio_channel_option }})" >> $GITHUB_STEP_SUMMARY
          echo "| Container | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|:-|:-|" >> $GITHUB_STEP_SUMMARY
          supervisor_version=$(jq -r ".supervisor" output/build/hassio-*/version.json)
          landingpage_version=$(curl -fsSL https://api.github.com/repos/home-assistant/landingpage/releases/latest | jq -r '.tag_name')
          echo "| supervisor | [${supervisor_version}](https://github.com/home-assistant/supervisor/releases/tag/${supervisor_version}) |" >> $GITHUB_STEP_SUMMARY
          echo "| landingpage | [${landingpage_version}](https://github.com/home-assistant/landingpage/releases/tag/${landingpage_version}) |" >> $GITHUB_STEP_SUMMARY
          for plugin in dns audio cli multicast observer; do
            version=$(jq -r ".${plugin}" output/build/hassio-*/version.json)
            echo "| plugin-${plugin} | [${version}](https://github.com/home-assistant/plugin-${plugin}/releases/tag/${version}) |" >> $GITHUB_STEP_SUMMARY
          done
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size (bytes) | Size (formatted) |" >> $GITHUB_STEP_SUMMARY
          echo "|:-|:-|:-|" >> $GITHUB_STEP_SUMMARY
          for f in output/images/haos_*; do
            echo "| $(basename $f) | $(du -b $f | cut -f1) | $(du -bh $f | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          done
          echo "## Partitions" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size (bytes) | Size (formatted) |" >> $GITHUB_STEP_SUMMARY
          echo "|:-|:-|:-|" >> $GITHUB_STEP_SUMMARY
          for f in boot.vfat kernel.img rootfs.erofs overlay.ext4 data.ext4; do
            echo "| ${f} | $(du -b output/images/$f | cut -f1) | $(du -bh output/images/$f | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload OS image artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: haos_${{ matrix.board.id }}-${{ needs.prepare.outputs.version_full }}.img.xz
          path: |
            output/images/haos_${{ matrix.board.id }}-${{ needs.prepare.outputs.version_full }}.img.xz
